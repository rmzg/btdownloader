#!/usr/bin/perl

use strict;
use warnings;

use String::ShellQuote qw/shell_quote/;

use Tickit;
use Tickit::Widgets qw/Box VBox HBox Button/;
use Tickit::Widget::Table::Paged;
BEGIN { *TW:: = *Tickit::Widget:: }

if( $ARGV[0] eq '-a' ) { $::SKIP_GUI = 1 }

my $ssh = 'ssh';
my $host = "dhau.rmz.gs";
my $dir = shell_quote "rt/done";

my @remote_files = map { 
	chomp; 
	my $x = [split " ", $_, 2];
	$x->[1] =~ s/$dir\/?//;
	$x 
} `$ssh $host du -hscL $dir/\\*`;
pop @remote_files; #du summary line
#chomp @remote_files;
#$_ = [split " ", $_, 2] for @remote_files;

my @selected_rows;

if( $::SKIP_GUI ) { 
	@selected_rows = @remote_files;
	goto BEGIN_DOWNLOAD;
}

my $tickit; 
my $table = TW::Table::Paged->new( 

	style => {
		highlight_bg => 'green',
		highlight_fg => 'black',
		cell_padding => 2,

		'<j>' => 'select_toggle',
		'<w>' => 'previous_row',
		'<s>' => 'next_row',
	},

	multi_select => 1,
	cursor_hidden => 1,
);

$table->{row_offset} = 0;
$table->add_column( Label => "Size", align => "left", width => 6 );
$table->add_column( Label => "File Name", align => "left", width => 80 );
$table->add_row( $_->[0], $_->[1] ) for @remote_files;


my $hbox = TW::HBox->new;
$hbox->add( 
TW::Box->new(child_lines => 3, child_cols => 16, child => 
	TW::Button->new( label => "Download", on_click => sub { @selected_rows = $table->selected_rows; $tickit->stop; } ),
	),
	expand => 1 
);
$hbox->add( 
TW::Box->new(child_lines => 3, child_cols => 16, child => 
	TW::Button->new( label => "Cancel", on_click => sub {$tickit->stop;exit;} ),
	),
	expand => 1 
);

my $vbox = TW::VBox->new;
$vbox->add( $table, expand => 1 );
$vbox->add( $hbox, expand => 1 );

my $box = TW::Box->new( 
	child_lines => 45,
	child_cols => 90,
	valign => 0.5,
	align => 'centre', 
	child => $vbox 
);

$tickit = Tickit->new( root => $box );
$tickit->run;


##################
# Start downloads based on selected files.
BEGIN_DOWNLOAD:
for my $row ( @selected_rows ) { 
	my $file = $row->[1];

	print "==== Starting $file ====\n\n";

	#my $scp_ret = system( $scp, "-r", "$host:$dir/\Q$file", "." );
	my $scp_ret = system( 'rsync', "-rvzL", "--progress", "--size-only", "$host:$dir/\Q$file", "." );
	if( $scp_ret == 0 ) { system( $ssh, $host, 'rm', '-f', "$dir/\Q$file" ) }



	print "\n";
}
